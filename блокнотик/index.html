<!doctype html>
<head>
    <meta charset="utf-8">
    <title>Блокнотик</title>
    <link rel="icon" type="image/png" id="favicon" href="images/emoji/whale2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.1.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.1.0/codemirror.min.js"></script>

    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>

    <link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.1.0/firepad.css">
    <script src="https://cdn.firebase.com/libs/firepad/1.1.0/firepad.min.js"></script>
    <link rel="stylesheet" href="firepad-userlist.css">
    <script src="firepad-userlist.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: relative;
            /* background: rgb(178, 223, 218) url(leaves.gif) no-repeat; */
            background: url(images/backgrounds/blur.jpg);
            background-size: cover;
            overflow: hidden;
        }
        #editor {
            max-width: 45em;
            margin: 0 auto;
            height: 100%;
        }
        .powered-by-firepad {
            display: none;
        }

        .firepad-richtext .CodeMirror {
            color: #555;
            background: #f5f5f0;
            padding: 0 10px 0 0;
            font: 12px/1.5em Consolas, Menlo, monospace;
        }

        .firepad-richtext .CodeMirror-gutters {
            background: transparent;
        }
    </style>
</head>

<body>
    <div id="user-list"></div>
    <div id="editor"></div>

    <script>
        var docCookies = {
          getItem: function (sKey) {
            if (!sKey) { return null; }
            return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
          },
          setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
            if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
            var sExpires = "";
            if (vEnd) {
              switch (vEnd.constructor) {
                case Number:
                  sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
                  break;
                case String:
                  sExpires = "; expires=" + vEnd;
                  break;
                case Date:
                  sExpires = "; expires=" + vEnd.toUTCString();
                  break;
              }
            }
            document.cookie = encodeURIComponent(sKey) + "=" + encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
            return true;
          }
        };
        var userId = docCookies.getItem('userid') || (Math.random()*1e20).toString(16);
        var userName = docCookies.getItem('username') || '';
        var userColor = docCookies.getItem('usercolor') || '#aaaaaa';
        docCookies.setItem('userid', userId, Infinity);

        var editorNode = document.getElementById('editor');
        var userListNode = document.getElementById('user-list');
        var dbURL = 'https://crackling-torch-2731.firebaseio.com/notepad';

        var firebaseRef = new Firebase(dbURL);
        var codeMirror = CodeMirror(editorNode, {
            lineWrapping: true,
            lineNumbers: true
        });
        var firepad = Firepad.fromCodeMirror(firebaseRef, codeMirror, {
            userId: userId,
            richTextToolbar: false,
            richTextShortcuts: true,
            userColor: userColor
        });
        // firepad.setUserId()
        var userList = FirepadUserList.fromDiv(
            firebaseRef.child('users'),
            userListNode,
            userId,
            userName,
            userColor
        );

        function emojify(node) {
            node.innerHTML = node.innerHTML.replace(/:([\w-]+):/g, function(match, img) {
                return '<img class="emoji" width="21" height="21" src="images/emoji/' + img + '.png" alt="' + match + '" title="' + match + '">';
            });
        }

        function setName(newName) {
            docCookies.setItem('username', newName, Infinity);
            userList.setName(newName);
        }

        function setColor(newColor) {
            docCookies.setItem('usercolor', newColor, Infinity);
            firepad.setUserColor(newColor);
        }

        function getTextContent() {
            return document.querySelector('.CodeMirror-code').textContent.replace(/[\s\d]/g, '');
        }

        function setFavicon(type) {
            document.getElementById('favicon').href = 'images/emoji/' + type + '.png';
        }

        firebaseRef.root().child('.info/connected').on('value', function(connectedSnap) {
          if (connectedSnap.val() === true) {
            document.body.style.opacity = '';
          } else {
            document.body.style.opacity = 0.5;
          }
        });

        window.onblur = function() {
            windowBlurred = true;
            lastSeenText = getTextContent();
        };
        window.onfocus = function() {
            windowBlurred = false;
            document.title = originalTitle;
            setFavicon('whale2');
        }

        var originalTitle = document.title;
        var lastSeenText = '';
        var windowBlurred = false;
        setInterval(function() {
            if (windowBlurred) {
                var newText = getTextContent();
                if (newText && newText != lastSeenText) {
                    document.title = '✱ ' + originalTitle;
                    setFavicon('bell');
                } else {
                    document.title = originalTitle;
                    setFavicon('whale2');
                }
            }
        }, 5000);
    </script>
</body>
</html>
